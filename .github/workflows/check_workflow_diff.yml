name: Workflow Directory Check

on:
  push:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  workflow_directory_check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: List PR Workflows
        run: |
          PR_WORKFLOWS=$(ls ${GITHUB_WORKSPACE}/.github/workflows)
          echo "Files in PR: $PR_WORKFLOWS"

      - name: List Base Workflows
        run: |
          BASE_WORKFLOWS=$(git ls-tree --name-only ${{ github.event.pull_request.base.sha }} .github/workflows)
          echo "Files in Base: $BASE_WORKFLOWS"

      - name: Compare Workflows
        id: diff
        run: |
          if [[ "$PR_WORKFLOWS" != "$BASE_WORKFLOWS" ]]; then
            echo "Workflow directories are not equivalent"
            exit 1
          else
            echo "Workflow directories are equivalent"
          fi

      - name: Update Status Check
        if: ${{ steps.diff.outcome == 'failure' }}
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -d '{
              "state": "failure",
              "context": "workflow-directory-check",
              "description": "Workflow directories are not equivalent",
              "target_url": "https://example.com/workflow-check-results"
            }'
