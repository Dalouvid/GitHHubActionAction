name: Workflow Directory Check

on:
  push:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  workflow_directory_check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Fetch Latest Changes
        run: git fetch origin
        
      - name: Find Common Ancestor
        id: common_ancestor
        run: |
          COMMON_ANCESTOR=$(git merge-base origin/main ${{ github.sha }})
          echo "COMMON_ANCESTOR_SHA=$COMMON_ANCESTOR" >> $GITHUB_ENV

      - name: Check Workflow Directory Changes
        id: diff
        run: |
          WORKFLOW_DIFF=$(git diff --name-only $COMMON_ANCESTOR_SHA...${{ github.sha }} .github/workflows)
          echo "WORKFLOW_DIFF=$WORKFLOW_DIFF" >> $GITHUB_ENV
        
      - name: Update Status Check
        if: env.WORKFLOW_DIFF != ''
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -d '{
              "state": "failure",
              "context": "workflow-directory-check",
              "description": "Workflow directories have changes",
              "target_url": "https://example.com/workflow-check-results"
            }'
